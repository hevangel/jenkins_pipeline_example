pipeline {
    agent none
    parameters {
        booleanParam(name: 'RunPullStage', defaultValue: true, description: 'Run Pull Stage')
        booleanParam(name: 'RunBuildStage', defaultValue: true, description: 'Run Build Stage')
        booleanParam(name: 'RunPushStage', defaultValue: true, description: 'Run Push Stage')
    }
    stages {
        // Pull image from docker register
        stage("Pull") {
            agent {
                docker {
                    image 'hevangel/jenkins_pipeline_test:latest'
                    args '-v $HOME/temp:/docker_temp'
                    // use the same node
                    reuseNode true
                }
            }
            when {
                expression {return params.RunPullStage}
                beforeAgent true
            }
            steps {
                sh 'pwd'
                sh 'ls /docker_temp'
                sh 'echo ${BUILD_TAG} > /docker_temp/build_tag.txt'
            }
        }
        // Build image from docker file
        stage("Build") {
            agent { 
                dockerfile {
                    args '-i --entrypoint='
                } 
            }
            when {
                expression {return params.RunBuildStage}
                beforeAgent true
            }
            steps {
                sh 'python3 dummy_test.py'
            }
        }
        // Build image from docker file
        stage("Push") {
            agent any 
            when {
                expression {return params.RunPushStage}
                beforeAgent true
            }
            steps {
                script {
                    dockerImage = docker.build "jenkins_pipeline_test"
                    docker.withRegistery('https://index.docker.io/v1/', 'docker') {
                        dockerImage.push "$BUILD_NUMBER"
                        dockerImage.push "latest"
                    }
                }
            }
        }       
    }
}
